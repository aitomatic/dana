"""Unified Testing Module for Financial Analysis Workflows.

This module is placed inside the `financial_analysis` package
and uses relative imports from within that package.
"""

from .fin_statements import get_total_asset, get_total_asset_2y, get_total_asset_3y
from .fin_statements import get_fixed_asset, get_fixed_asset_2y, get_fixed_asset_3y
from .fin_statements import get_curr_asset, get_curr_asset_2y, get_curr_asset_3y
from .fin_statements import get_cash_and_equiv, get_cash_and_equiv_2y, get_cash_and_equiv_3y
from .fin_statements import get_st_inv, get_st_inv_2y, get_st_inv_3y
from .fin_statements import get_recvable, get_recvable_2y, get_recvable_3y
from .fin_statements import get_inventory, get_inventory_2y, get_inventory_3y
from .fin_statements import get_curr_liab, get_curr_liab_2y, get_curr_liab_3y
from .fin_statements import get_payable, get_payable_2y, get_payable_3y
from .fin_statements import get_lt_debt, get_lt_debt_2y, get_lt_debt_3y
from .fin_statements import get_st_debt, get_st_debt_2y, get_st_debt_3y
from .fin_statements import get_equity, get_equity_2y, get_equity_3y
from .fin_statements import get_op_cf, get_op_cf_2y, get_op_cf_3y
from .fin_statements import get_capex, get_capex_2y, get_capex_3y
from .fin_statements import get_rev, get_rev_2y, get_rev_3y
from .fin_statements import get_cogs, get_cogs_2y, get_cogs_3y
from .fin_statements import get_gross_income, get_gross_income_2y, get_gross_income_3y
from .fin_statements import get_ga_exp, get_ga_exp_2y, get_ga_exp_3y
from .fin_statements import get_op_income, get_op_income_2y, get_op_income_3y
from .fin_statements import get_deprec_and_amort, get_deprec_and_amort_2y, get_deprec_and_amort_3y
from .fin_statements import get_ebit, get_ebit_2y, get_ebit_3y
from .fin_statements import get_int_exp, get_int_exp_2y, get_int_exp_3y
from .fin_statements import get_ebt, get_ebt_2y, get_ebt_3y
from .fin_statements import get_tax_exp, get_tax_exp_2y, get_tax_exp_3y
from .fin_statements import get_net_income, get_net_income_2y, get_net_income_3y
from .fin_statements import get_div, get_div_2y, get_div_3y

from .adj_income import calc_ebitda, calc_ebitda_2y, calc_ebitda_3y

from .turnover_ratios import calc_total_asset_turnover_ratio
from .turnover_ratios import calc_fixed_asset_turnover_ratio
from .turnover_ratios import calc_inventory_turnover_ratio

from .margin_ratios import calc_cogs_margin, calc_cogs_margin_3y_avg
from .margin_ratios import calc_gross_margin, calc_gross_margin_3y_avg
from .margin_ratios import calc_ebitda_margin, calc_ebitda_margin_3y_avg
from .margin_ratios import calc_da_margin
from .margin_ratios import calc_op_margin, calc_op_margin_3y_avg
from .margin_ratios import calc_ebit_margin, calc_ebit_margin_3y_avg
from .margin_ratios import calc_net_margin, calc_net_margin_3y_avg

from .return_ratios import calc_roa_ratio, calc_roe_ratio

from .liquidity import calc_quick_ratio
from .liquidity import calc_net_work_cap, calc_work_cap_ratio
from .liquidity import calc_op_cf_ratio
from .liquidity import calc_fcf, calc_fcf_conv_ratio
from .liquidity import calc_dio, calc_dso, calc_dpo, calc_ccc

from .cap_intens import calc_fixed_asset_over_total_asset
from .cap_intens import calc_total_asset_over_rev
from .cap_intens import calc_capex_over_rev, calc_capex_over_rev_3y_avg
from .cap_intens import assess_cap_intens

from .leverage import calc_total_debt, calc_total_debt_2y, calc_total_debt_3y
from .leverage import calc_de_ratio

from .income_util_ratios import calc_int_cov_ratio, calc_eff_tax_rate
from .income_util_ratios import calc_div_payout_ratio, calc_retention_ratio

from .utils import FinDoc

TEST_path: str = 'test-assets/AMD_2022_10K.pdf'

TEST_ARGS = FinDoc(company='AMD', period='2022')

WORKFLOWS_BY_ANALYSIS_AREA: dict[str, list[callable]] = {
    'statements_reading': [
        get_total_asset, get_total_asset_2y, get_total_asset_3y,
        get_fixed_asset, get_fixed_asset_2y, get_fixed_asset_3y,
        get_curr_asset, get_curr_asset_2y, get_curr_asset_3y,
        get_cash_and_equiv, get_cash_and_equiv_2y, get_cash_and_equiv_3y,
        get_st_inv, get_st_inv_2y, get_st_inv_3y,
        get_recvable, get_recvable_2y, get_recvable_3y,
        get_inventory, get_inventory_2y, get_inventory_3y,
        get_curr_liab, get_curr_liab_2y, get_curr_liab_3y,
        get_payable, get_payable_2y, get_payable_3y,
        get_lt_debt, get_lt_debt_2y, get_lt_debt_3y,
        get_st_debt, get_st_debt_2y, get_st_debt_3y,
        get_equity, get_equity_2y, get_equity_3y,
        get_op_cf, get_op_cf_2y, get_op_cf_3y,
        get_capex, get_capex_2y, get_capex_3y,
        get_rev, get_rev_2y, get_rev_3y,
        get_cogs, get_cogs_2y, get_cogs_3y,
        get_gross_income, get_gross_income_2y, get_gross_income_3y,
        get_ga_exp, get_ga_exp_2y, get_ga_exp_3y,
        get_deprec_and_amort, get_deprec_and_amort_2y, get_deprec_and_amort_3y,
        get_op_income, get_op_income_2y, get_op_income_3y,
        get_ebit, get_ebit_2y, get_ebit_3y,
        get_int_exp, get_int_exp_2y, get_int_exp_3y,
        get_ebt, get_ebt_2y, get_ebt_3y,
        get_tax_exp, get_tax_exp_2y, get_tax_exp_3y,
        get_net_income, get_net_income_2y, get_net_income_3y,
        get_div, get_div_2y, get_div_3y,
    ],
    'adj_income': [
        calc_ebitda,
        calc_ebitda_2y,
        calc_ebitda_3y,
    ],
    'turnover_ratios': [
        calc_total_asset_turnover_ratio,
        calc_fixed_asset_turnover_ratio,
        calc_inventory_turnover_ratio,
    ],
    'margin_ratios': [
        calc_cogs_margin,
        calc_cogs_margin_3y_avg,
        calc_gross_margin,
        calc_gross_margin_3y_avg,
        calc_ebitda_margin,
        calc_ebitda_margin_3y_avg,
        calc_da_margin,
        calc_op_margin,
        calc_op_margin_3y_avg,
        calc_ebit_margin,
        calc_ebit_margin_3y_avg,
        calc_net_margin,
        calc_net_margin_3y_avg,
    ],
    'return_ratios': [
        calc_roa_ratio,
        calc_roe_ratio,
    ],
    'liquidity': [
        calc_quick_ratio,
        calc_net_work_cap,
        calc_work_cap_ratio,
        calc_op_cf_ratio,
        calc_fcf,
        calc_fcf_conv_ratio,
        calc_dio,
        calc_dso,
        calc_dpo,
        calc_ccc,
    ],
    'cap_intens': [
        calc_fixed_asset_over_total_asset,
        calc_total_asset_over_rev,
        calc_capex_over_rev,
        calc_capex_over_rev_3y_avg,
        assess_cap_intens,
    ],
    'leverage': [
        calc_total_debt,
        calc_total_debt_2y,
        calc_total_debt_3y,
        calc_de_ratio,
    ],
    'income_util_ratios': [
        calc_int_cov_ratio,
        calc_eff_tax_rate,
        calc_div_payout_ratio,
        calc_retention_ratio,
    ],
}

# Function to test all workflows
# ==============================
def test_all_workflows():
    """Test all workflows for all analysis areas."""
    for area in WORKFLOWS_BY_ANALYSIS_AREA:
        workflows = WORKFLOWS_BY_ANALYSIS_AREA[area]
        print(f'=== Testing {area} ===')
        for workflow in workflows:
            func_name = str(workflow)
            print(f'-- {func_name} --')
            try:
                result = workflow(TEST_ARGS)
                print(f'PASS: {func_name} => {result}')
            except Exception as e:
                print(f'FAIL: {func_name} => {e}')

def __main__():
    # Run a few tests
    # ===============
    # simple statements reading
    print(f'TOTAL ASSET: {get_total_asset(TEST_ARGS)}')
    print(f'TOTAL REVENUE: {get_rev(TEST_ARGS)}')
    print(f'OPERATING CASH FLOW: {get_op_cf(TEST_ARGS)}')
