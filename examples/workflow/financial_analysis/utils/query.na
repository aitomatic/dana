"""Financial Data Query."""


from .types import FinDoc


__all__ = ['query_fin_data']


def query_fin_data(doc: FinDoc,
                   line_item: str, statement: str,
                   as_at_period_end: bool = False,
                   n_years: int = 1) -> str:  # TODO: Literal[1, 2, 3]
    """Query financial statement item value(s)."""

    # TODO: ... if ... else ... pattern in Dana

    if n_years == 1:
        if as_at_period_end:
            time_period_str: str = f'as at {doc.period.upper()} fiscal period end'
        else:
            time_period_str: str = f'for {doc.period.upper()} fiscal period'

        query: str = (
f'What is value in {doc.currency.upper()} of

`{line_item}`
(or most similar-meaning reported line item)

on `{statement}`
(or most similar-meaning statement)

of {doc.company.upper()}

{time_period_str}?')

    else:
        if n_years == 2:
            if as_at_period_end:
                time_period_str: str = (
f'as at following two annual fiscal period ends:
- previous annual fiscal period end immediately preceding {doc.period.upper()}; and
- current {doc.period.upper()} annual fiscal period end')

            else:
                time_period_str: str = (
f'for following two annual fiscal periods:
- previous annual fiscal period end immediately preceding {doc.period.upper()}; and
- current {doc.period.upper()} annual fiscal period end')

        else:
            if as_at_period_end:
                time_period_str: str = (
f'as at ends of past 3 annual fiscal periods
with the last year being {doc.period.upper()} annual fiscal period')

            else:
                time_period_str: str = (
f'for past 3 fiscal years
with the last year being {doc.period.upper()} annual fiscal period')

        query: str = (
f'What are values in {doc.currency.upper()} of

`{line_item}`
(or most similar-meaning reported line item)

on `{statement}`
(or most similar-meaning statement)

of {doc.company.upper()}

{time_period_str}?')

    if doc.path:
        with use('rag', sources=[doc.path]) as docs_resource:
            return reason(query)

    return llm(query)
