# GitHub Action to run Ruff code analysis
# - Runs on Python 3.12+
# - Uses Ruff for fast, comprehensive code quality analysis
# - Uses pyproject.toml configuration for Dana standards
# - Focuses on critical code quality issues

name: Ruff Lint

on: 
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:  # Allow manual triggering

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.12"]
    steps:
    - uses: actions/checkout@v4
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
    - name: Install uv
      uses: astral-sh/setup-uv@v6
    - name: Cache uv dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/uv
        key: uv-${{ runner.os }}-${{ hashFiles('uv.lock') }}
        restore-keys: |
          uv-${{ runner.os }}-
    - name: Install dependencies
      run: uv sync --extra dev
    - name: Critical lint checks (BLOCKING)
      env:
        PYTHONPATH: ${{ github.workspace }}
      run: |
        echo "üö´ Running critical lint checks (BLOCKING)..."
        echo "Checking core modules for: bare except (E722), undefined names (F821)"
        echo "Using pyproject.toml configuration"
        uv run ruff check dana/ tests/ --select E722,F821 --exclude dana/contrib --output-format=github || {
          echo "‚ùå Critical lint violations found in core modules"
          echo "These must be fixed as they can cause runtime errors or security issues"
          echo "Run: uv run ruff check dana/ tests/ --select E722,F821 --exclude dana/contrib"
          exit 1
        }
        echo "‚úÖ Critical lint checks passed for core modules"
        
    - name: Important lint checks (WARNING)  
      env:
        PYTHONPATH: ${{ github.workspace }}
      run: |
        echo "‚ö†Ô∏è Running important lint checks (non-blocking)..."
        echo "Checking for: unused variables (F841), assert exceptions (B017)"
        uv run ruff check dana/ tests/ --select F841,B017 --output-format=github || {
          echo "‚ö†Ô∏è Found important issues - should fix soon but CI continues"
        }
        
    - name: Style and formatting checks (INFO)
      env:
        PYTHONPATH: ${{ github.workspace }}
      run: |
        echo "‚ú® Running style and formatting checks (non-blocking)..."
        uv run ruff format --check dana/ tests/ || {
          echo "‚ÑπÔ∏è Formatting issues found - run 'uv run ruff format dana/ tests/' to fix"
        }
        uv run ruff check dana/ tests/ --select UP038,B026,E712,E721,B024,B007 --output-format=github || {
          echo "‚ÑπÔ∏è Style issues found - fix when convenient"
        } 